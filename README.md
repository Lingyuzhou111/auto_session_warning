# 自动掉线预警插件

## 插件简介

自动掉线预警插件是一个独立的微信session掉线预警系统，专为`dify-on-wechat-ipad`项目设计。该插件能够监控微信登录状态，在session即将过期时自动发送预警消息和登录二维码，帮助用户及时重新登录以保持服务连续性。

## 主要功能

### 1. 主动查询功能
- **$预警状态** - 查询当前在线时间和预计掉线时间
- **$预警配置** - 获取当前预警配置信息

### 2. 预警管理功能
- **$预警启用** - 开启自动掉线预警模式
- **$预警禁用** - 关闭自动掉线预警模式
- **$预警阈值 xh** - 调整预警触发时间阈值

### 3. 测试功能
- **$预警测试** - 手动进行掉线预警功能测试

## 指令详解

### $预警状态
主动查询当前在线时间和预计掉线时间
**示例回复:**
```
⚠️ 当前预警状态
您已持续在线超过0.1小时，预计70.9小时内即将掉线。
```

### $预警配置
获取相关配置信息
**示例回复:**
```
📋 配置信息:
   API服务器: 127.0.0.1:9011/VXAPI
   登录微信ID: 机器人wxid
   设备ID: 你的设备id
   预警接收者: 管理员wxid
   预警状态: 已启用
   预警阈值: 2小时
```

### $预警启用/$预警禁用
开启或关闭自动掉线预警模式
**回复:**
- `✅ 已启用自动掉线预警功能`
- `⛔️ 已禁用自动掉线预警功能`

### $预警阈值 xh
调整掉线预警时间，当在线时间超过(72h-xh)时触发预警
**使用示例:** `$预警阈值 2h`
**回复:**
```
✅ 已调整预警阈值为2小时，当持续在线时长超过70小时时将自动触发预警。
```

### $预警测试
随时进行掉线预警功能测试
**示例回复:**
```
⚠️ 掉线预警测试
您已持续在线超过60小时，预计12小时内即将掉线。
为避免服务中断，请手动扫码重新登录！稍后将为您发送登录二维码。
（等待1秒后生成并发送二维码图片）
```



## 配置说明

插件配置保存在`plugins/auto_session_warning/config.json`文件中：

```json
{
    "auto_session_warning_enabled": true,
    "auto_session_warning_threshold": 2,
    "auto_session_warning_target": "管理员wxid",
    "api_host": "127.0.0.1",
    "api_port": 9011,
    "api_path_prefix": "/VXAPI",
    "session_duration_hours": 72,
    "check_interval_hours": 2
}
```

### 配置参数说明
- `auto_session_warning_enabled`: 是否启用自动预警功能
- `auto_session_warning_threshold`: 预警阈值（小时）
- `auto_session_warning_target`: 预警消息接收者的微信ID
- `api_host`: WX849 API服务器地址
- `api_port`: WX849 API服务器端口
- `api_path_prefix`: API路径前缀
- `session_duration_hours`: Session有效期（小时）
- `check_interval_hours`: 后台检查间隔（小时）

## 工作原理

### 1. 登录时间获取
插件从`wx849_device_info.json`文件中获取最新的登录时间戳，这个时间戳由`wx849_channel.py`在用户登录时动态更新。

### 2. 后台监控
当预警功能启用时，插件会启动后台线程，按照配置的检查间隔定期检查当前在线时长。

### 3. 预警触发
当在线时长超过`(72小时 - 预警阈值)`时，插件会自动发送预警消息和登录二维码给指定的接收者。

### 4. 防重复机制
插件内置了防重复发送机制，同一预警周期内最多只发送一次预警消息。

### 5. 专注预警功能
插件专注于核心的掉线预警功能，移除了无效的自动刷新机制，确保用户能及时收到真实有效的掉线预警。

## 安装和启用

1. 将插件文件放置在`plugins/auto_session_warning/`目录下
2. 配置`config.json`文件中的预警接收者微信ID
3. 重启程序或使用`#scanp`命令扫描插件
4. 插件会自动启用并开始监控

## 依赖关系

- **wx849_channel.py**: 提供登录时间戳更新功能
- **wx849_device_info.json**: 存储当前登录信息和时间戳
- **WX849 API服务**: 提供消息发送和二维码生成功能

## 注意事项

1. 确保`auto_session_warning_target`配置为有效的微信ID
2. 插件需要WX849 API服务正常运行
3. 预警阈值建议设置为2-6小时之间
4. 插件会自动处理API格式兼容性问题

## 故障排除

### 常见问题
1. **无法获取登录信息**: 检查`wx849_device_info.json`文件是否存在
2. **预警消息发送失败**: 检查API服务器连接和配置
3. **二维码发送失败**: 检查网络连接和API服务状态

### 日志查看
插件运行日志会输出到系统日志中，标识为`[AutoSessionWarning]`，可通过查看日志了解插件运行状态。

## 版本信息

- **版本**: 1.0
- **作者**: Assistant
- **兼容性**: dify-on-wechat-ipad项目
- **依赖**: Python 3.7+, aiohttp, 插件系统框架 
